<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Car Rental PRO â€” Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
Â  Â  --bg:#f5f7fb;
Â  Â  --sidebar:#131427;
Â  Â  --accent:#5eead4;
Â  Â  --muted:#6b7280;
Â  Â  --card:#ffffff;
Â  Â  --danger:#ef4444;
Â  Â  --success:#10b981;
}
*{box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
body{margin:0;background:var(--bg);color:#0f1724}
.app{display:flex;height:100vh;overflow:hidden}
/* Sidebar */
.sidebar{width:280px;background:linear-gradient(180deg,var(--sidebar),#0e1220);color:#fff;padding:22px;display:flex;flex-direction:column;gap:12px}
.logo{font-weight:800;font-size:18px;display:flex;align-items:center;gap:10px}
.logo .badge{background:var(--accent);color:#012;padding:6px 10px;border-radius:10px;font-weight:700}
.nav{margin-top:6px;display:flex;flex-direction:column;gap:6px}
.nav button{background:transparent;border:none;color:#dbeafe;padding:12px 14px;text-align:left;border-radius:10px;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.nav button.active{background:rgba(255,255,255,0.06)}
.small{color:#9aa4b2;font-size:13px}
.sidebar .foot{margin-top:auto;font-size:13px;color:#93a2b6}
/* Main area */
.main{flex:1;padding:20px;overflow:auto}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:linear-gradient(90deg,#06b6d4,#8b5cf6);border:none;color:#021;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.08);color:inherit}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:16px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.stat-title{font-size:13px;color:var(--muted)}
.stat-value{font-size:24px;font-weight:800;margin-top:6px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:right;font-size:14px}
input,select,textarea{padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff;width:100%;font-size:14px}
.row{display:flex;gap:10px}
.row .col{flex:1}
.tag{padding:6px 8px;border-radius:999px;font-weight:700}
.tag.in{background:var(--success);color:#021}
.tag.out{background:var(--danger);color:#021}
.muted{color:var(--muted)}
.settings-line{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-top:1px dashed #eef2f7}
/* responsive */
@media(max-width:980px){
Â  Â  .grid3{grid-template-columns:1fr}
Â  Â  .sidebar{display:none}
Â  Â  .app.mobile .sidebar{display:block;position:fixed;z-index:40;left:0;top:0;height:100vh}
}
</style>
</head>
<body>

<div class="app" id="appRoot">

Â  Â  <aside class="sidebar" id="sidebar">
Â  Â  <div class="logo"><div class="badge">CR</div><div>Car Rental <span class="muted">PRO</span></div></div>
Â  Â  <div class="small">Welcome, <strong id="uiUser">Guest</strong></div>

Â  Â  <nav class="nav" id="nav">
Â  Â  Â  <button data-tab="dashboard" class="active">Dashboard <span class="muted">ğŸ“Š</span></button>
Â  Â  Â  <button data-tab="cars">Cars Management <span class="muted">ğŸš˜</span></button>
Â  Â  Â  <button data-tab="entries">Income & Expenses <span class="muted">ğŸ’µ</span></button>
Â  Â  Â  <button data-tab="reports">Reports <span class="muted">ğŸ“„</span></button>
Â  Â  Â  <button data-tab="backup">Backup & Export <span class="muted">ğŸ—‚</span></button>
Â  Â  Â  <button data-tab="settings">Settings <span class="muted">âš™ï¸</span></button>
Â  Â  Â  <button data-tab="users">Users & Roles <span class="muted">ğŸ‘¥</span></button>
Â  Â  </nav>

Â  Â  <div style="margin-top:10px">
Â  Â  Â  <button id="btnLogin" class="btn ghost" style="width:100%">Sign in / Switch User</button>
Â  Â  </div>

Â  Â  <div class="foot muted" style="margin-top:auto">
Â  Â  Â  Local mock server â€” no external network. Data stored in browser storage.
Â  Â  </div>
Â  </aside>

Â  Â  <main class="main">
Â  Â  <div class="topbar">
Â  Â  Â  <h1 style="margin:0">Car Rental PRO â€” Admin Dashboard</h1>
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <label class="muted" style="font-size:13px">Auto backup</label>
Â  Â  Â  Â  <input type="checkbox" id="autoBackupToggle" />
Â  Â  Â  Â  <button id="btnDownloadBackup" class="btn ghost">Download Backup</button>
Â  Â  Â  Â  <button id="btnImportBackup" class="btn">Import Backup</button>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <section id="tab-dashboard" class="tab">
Â  Â  Â  <div class="grid3" style="margin-bottom:12px">
Â  Â  Â  Â  <div class="card stat-box">
Â  Â  Â  Â  Â  <div class="stat-title">Total Revenue</div>
Â  Â  Â  Â  Â  <div class="stat-value" id="statRevenue">0</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card stat-box">
Â  Â  Â  Â  Â  <div class="stat-title">Total Expenses</div>
Â  Â  Â  Â  Â  <div class="stat-value" id="statExpenses">0</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card stat-box">
Â  Â  Â  Â  Â  <div class="stat-title">Net Profit</div>
Â  Â  Â  Â  Â  <div class="stat-value" id="statNet">0</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  Â  <h3 style="margin:0">Monthly Trend</h3>
Â  Â  Â  Â  Â  <div class="muted">Revenue vs Expenses</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <canvas id="chartMonthly" height="120" style="margin-top:12px"></canvas>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="tab-cars" class="tab" style="display:none">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  Â  <h3 style="margin:0">Cars Management</h3>
Â  Â  Â  Â  Â  <div class="muted">Add, edit or delete cars</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:12px" class="row">
Â  Â  Â  Â  Â  <div class="col"><input id="carName" placeholder="Car name / model (e.g. Toyota Corolla 2019)" /></div>
Â  Â  Â  Â  Â  <div style="width:160px"><input id="carPlate" placeholder="Plate (optional)" /></div>
Â  Â  Â  Â  Â  <div style="width:160px"><input id="carDailyRent" placeholder="Daily Rent" type="number" min="0" step="0.01" /></div>
Â  Â  Â  Â  Â  <div style="width:120px"><button id="btnAddCar" class="btn">Add Car</button></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:14px">
Â  Â  Â  Â  Â  <table id="carsTable">
Â  Â  Â  Â  Â  Â  <thead><tr><th>Car</th><th>Plate</th><th>Daily Rent</th><th>Entries</th><th>Actions</th></tr></thead>
Â  Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="tab-entries" class="tab" style="display:none">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h3 style="margin:0">Add Entry</h3>
Â  Â  Â  Â  <div class="muted">Record income or expense for any car</div>

Â  Â  Â  Â  <div style="margin-top:12px" class="row">
Â  Â  Â  Â  Â  <div class="col"><select id="entryCar"></select></div>
Â  Â  Â  Â  Â  <div style="width:170px"><input id="entryDate" type="date" /></div>
Â  Â  Â  Â  Â  <div style="width:140px">
Â  Â  Â  Â  Â  Â  <select id="entryType"><option value="income">Income</option><option value="expense">Expense</option></select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:10px" class="row">
Â  Â  Â  Â  Â  <div class="col"><input id="entryAmount" placeholder="Amount (numeric)" type="number" step="0.01" /></div>
Â  Â  Â  Â  Â  <div class="col"><input id="entryCategory" placeholder="Category (e.g. Rent, Fuel, Repair)" /></div>
Â  Â  Â  Â  Â  <div style="width:160px"><button id="btnAddEntry" class="btn">Save Entry</button></div>
Â  Â  Â  Â  </div>

Â  Â  Â  </div>

Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  Â  <h3 style="margin:0">Entries</h3>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <select id="filterCar"><option value="all">All cars</option></select>
Â  Â  Â  Â  Â  Â  <input id="filterFrom" type="date" />
Â  Â  Â  Â  Â  Â  <input id="filterTo" type="date" />
Â  Â  Â  Â  Â  Â  <button id="btnApplyFilter" class="btn ghost">Apply</button>
Â  Â  Â  Â  Â  Â  <button id="btnClearFilter" class="btn ghost">Clear</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:12px;overflow:auto">
Â  Â  Â  Â  Â  <table id="entriesTable">
Â  Â  Â  Â  Â  Â  <thead><tr><th>Date</th><th>Car</th><th>Type</th><th>Category</th><th>Amount</th><th>Note</th><th>Actions</th></tr></thead>
Â  Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="tab-reports" class="tab" style="display:none">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h3 style="margin:0">Generate Reports</h3>
Â  Â  Â  Â  <div class="muted">Create summary, monthly or custom reports and export as PDF / Excel / CSV</div>

Â  Â  Â  Â  <div style="margin-top:12px" class="row">
Â  Â  Â  Â  Â  <div class="col"><select id="reportCar"><option value="all">All cars</option></select></div>
Â  Â  Â  Â  Â  <div style="width:170px"><input id="reportFrom" type="date" /></div>
Â  Â  Â  Â  Â  <div style="width:170px"><input id="reportTo" type="date" /></div>
Â  Â  Â  Â  Â  <div style="width:130px"><button id="btnGenerate" class="btn">Generate</button></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:12px" id="reportSummary" class="card"></div>

Â  Â  Â  Â  <div style="margin-top:8px;display:flex;gap:8px">
Â  Â  Â  Â  Â  <button id="btnExportCSVReport" class="btn ghost">Export CSV</button>
Â  Â  Â  Â  Â  <button id="btnExportXLS" class="btn ghost">Export Excel</button>
Â  Â  Â  Â  Â  <button id="btnExportPDF" class="btn">Export PDF</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="tab-backup" class="tab" style="display:none">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h3>Backup & Restore</h3>
Â  Â  Â  Â  <div class="muted">Download a JSON backup or restore from a file. Auto-backup can keep one copy in localStorage.</div>
Â  Â  Â  Â  <div style="margin-top:12px" class="row">
Â  Â  Â  Â  Â  <div style="width:160px"><button id="btnDownload" class="btn">Download Backup</button></div>
Â  Â  Â  Â  Â  <div style="width:160px"><button id="btnUpload" class="btn ghost">Restore Backup</button></div>
Â  Â  Â  Â  Â  <div style="width:200px"><button id="btnClearAll" class="btn ghost" style="background:#fee2e2;color:var(--danger)">Reset All Data</button></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="tab-settings" class="tab" style="display:none">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h3>Settings</h3>
Â  Â  Â  Â  <div class="muted">Application settings (currency, auto-backup interval, language)</div>

Â  Â  Â  Â  <div style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="settings-line">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:700">Currency</div>
Â  Â  Â  Â  Â  Â  Â  <div class="muted">Choose display currency</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="width:200px"><input id="settingCurrency" value="MRU" /></div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="settings-line">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:700">Auto Backup Interval (minutes)</div>
Â  Â  Â  Â  Â  Â  Â  <div class="muted">When Auto Backup is enabled, this interval defines how often a backup is auto-saved.</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="width:220px"><input id="settingAutoInterval" type="number" min="1" value="60" /></div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div class="settings-line">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:700">Theme</div>
Â  Â  Â  Â  Â  Â  Â  <div class="muted">Light / Dark (UI theme)</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="width:160px">
Â  Â  Â  Â  Â  Â  Â  <select id="settingTheme"><option value="light">Light</option><option value="dark">Dark</option></select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section id="tab-users" class="tab" style="display:none">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <h3>Users & Roles</h3>
Â  Â  Â  Â  <div class="muted">Manage app users (mock auth). Admin can create/delete users and assign roles.</div>

Â  Â  Â  Â  <div style="margin-top:12px" class="row">
Â  Â  Â  Â  Â  <div class="col"><input id="newUserName" placeholder="Full name" /></div>
Â  Â  Â  Â  Â  <div class="col"><input id="newUserEmail" placeholder="Email" /></div>
Â  Â  Â  Â  Â  <div style="width:160px"><select id="newUserRole"><option value="admin">Admin</option><option value="manager">Manager</option><option value="user">User</option></select></div>
Â  Â  Â  Â  Â  <div style="width:120px"><button id="btnAddUser" class="btn">Add User</button></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:12px">
Â  Â  Â  Â  Â  <table id="usersTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody></tbody></table>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </section>

Â  </main>
</div>

<div id="modalLogin" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);align-items:center;justify-content:center;z-index:50">
Â  <div style="background:#fff;padding:18px;border-radius:12px;width:420px">
Â  Â  <h3 style="margin:0 0 8px 0">Sign in (mock)</h3>
Â  Â  <div class="small">Demo users: admin@demo (admin), manager@demo (manager), user@demo (user) â€” password: 123456</div>
Â  Â  <div style="margin-top:12px" class="row">
Â  Â  Â  <div class="col"><input id="loginEmail" placeholder="Email" value="admin@demo" /></div>
Â  Â  Â  <div style="width:160px"><input id="loginPass" placeholder="Password" value="123456" /></div>
Â  Â  Â  </div>
Â  Â  <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
Â  Â  Â  <button id="btnDoLogin" class="btn">Sign in</button>
Â  Â  Â  <button id="btnCloseLogin" class="btn ghost">Close</button>
Â  Â  </div>
Â  </div>
</div>

<script>
/* ============================
Â  Â Mock "backend" state stored in localStorage
Â  Â ============================ */
const STORAGE_KEY = 'car_rental_pro_v1';
const AUTO_BACKUP_KEY = 'car_rental_pro_autobackup';
const LAST_RENT_DATE_KEY = 'cr_last_rent_date'; // Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯ Ù„ØªØ®Ø²ÙŠÙ† Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® ØªÙ… ÙÙŠÙ‡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±

// Default initial state
function defaultState(){
Â  const today = new Date().toISOString().slice(0,10);
Â  return {
Â  Â  users:[
Â  Â  Â  {id:1,name:'Administrator',email:'admin@demo',password:'123456',role:'admin'},
Â  Â  Â  {id:2,name:'Manager',email:'manager@demo',password:'123456',role:'manager'},
Â  Â  Â  {id:3,name:'Staff',email:'user@demo',password:'123456',role:'user'}
Â  Â  ],
Â  Â  cars:[
Â  Â  Â  {id: 'c1', name:'Toyota Corolla 2019', plate:'T-1234', dailyRent: 1500}, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ
Â  Â  Â  {id: 'c2', name:'Hyundai Accent 2018', plate:'H-4321', dailyRent: 900} Â // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ
Â  Â  ],
Â  Â  entries:[
Â  Â  Â  {id:'e1',carId:'c1',date:today,type:'income',amount:1200,category:'Daily rent',note:'Daily rent'},
Â  Â  Â  {id:'e2',carId:'c2',date:today,type:'expense',amount:200,category:'Fuel',note:'Fuel refill'}
Â  Â  ],
Â  Â  settings:{
Â  Â  Â  currency:'MRU',
Â  Â  Â  autoBackupIntervalMinutes:60,
Â  Â  Â  theme:'light'
Â  Â  }
Â  };
}

let state = loadState();
let currentUser = JSON.parse(localStorage.getItem('cr_current_user')||'null');
let autoBackupTimer = null;

// --- Persistence
function loadState(){
Â  try{
Â  Â  const raw = localStorage.getItem(STORAGE_KEY);
Â  Â  if(!raw){ const s = defaultState(); localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); return s; }
Â  Â  return JSON.parse(raw);
Â  }catch(e){
Â  Â  console.error('failed load',e); const s = defaultState(); localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); return s;
Â  }
}
function saveState(){
Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ============================
Â  Â General Helpers
Â  Â ============================ */
// Helper to escape HTML to prevent XSS
function escapeHtml(str) {
Â  if (typeof str !== 'string') return str;
Â  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

// Helper to format currency
function formatMoney(amount) {
Â  const currency = state.settings.currency || 'MRU';
Â  // Use toLocaleString for better formatting, assuming a simple numeric locale
Â  return Number(amount).toLocaleString('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 2 }).replace(currency, '').trim() + ' ' + currency;
}

// Helper to download file
function downloadFile(filename, contentType, content) {
Â  const a = document.createElement('a');
Â  const blob = new Blob([content], { type: contentType });
Â  a.href = URL.createObjectURL(blob);
Â  a.download = filename;
Â  document.body.appendChild(a);
Â  a.click();
Â  document.body.removeChild(a);
}


/* ============================
Â  Â Daily Rent Automation Logic
Â  Â ============================ */
function processDailyRent(){
Â  const today = new Date().toISOString().slice(0,10);
Â  const lastRentDate = localStorage.getItem(LAST_RENT_DATE_KEY);
Â  
Â  // Check if daily rent was already processed today
Â  if(lastRentDate === today) {
Â  Â  console.log('Daily rent already processed for today:', today);
Â  Â  return;
Â  }

Â  console.log('Processing daily rent for', today);
Â  
Â  state.cars.forEach(car => {
Â  Â  const rent = parseFloat(car.dailyRent);
Â  Â  if(rent > 0){
Â  Â  Â  const id = 'e'+Date.now().toString(36) + '-' + car.id;
Â  Â  Â  state.entries.push({
Â  Â  Â  Â  id: id,
Â  Â  Â  Â  carId: car.id,
Â  Â  Â  Â  date: today,
Â  Â  Â  Â  type: 'income',
Â  Â  Â  Â  amount: rent,
Â  Â  Â  Â  category: 'Daily Automated Rent',
Â  Â  Â  Â  note: `Daily Rent - Car: ${car.name}`
Â  Â  Â  });
Â  Â  }
Â  });

Â  // Save new state and mark today as processed
Â  if(state.cars.some(c => parseFloat(c.dailyRent) > 0)){
Â  Â  saveState();
Â  Â  localStorage.setItem(LAST_RENT_DATE_KEY, today);
Â  Â  console.log('Daily rent added successfully.');
Â  }
}


/* ============================
Â  Â UI helpers & rendering
Â  Â ============================ */
const tabs = Array.from(document.querySelectorAll('[data-tab]')).map(b=>b.dataset.tab);
document.querySelectorAll('#nav button').forEach(btn=>{
Â  btn.addEventListener('click', ()=> {
Â  Â  document.querySelectorAll('#nav button').forEach(x=>x.classList.remove('active'));
Â  Â  btn.classList.add('active');
Â  Â  showTab(btn.dataset.tab);
Â  });
});

function showTab(id){
Â  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
Â  const el = document.getElementById('tab-'+id);
Â  if(el) el.style.display='block';
Â  // render if needed
Â  if(id==='cars') renderCarsTable();
Â  if(id==='entries') renderEntriesTable();
Â  if(id==='reports') renderReportSummary();
Â  if(id==='backup') {}
Â  if(id==='users') renderUsers();
Â  if(id==='dashboard') updateDashboard();
Â  // update UI user label
Â  document.getElementById('uiUser').innerText = currentUser ? `${currentUser.name} (${currentUser.role})` : 'Guest';
}

/* ---- Chart ---- */
let monthlyChart = null;
function updateMonthlyChart(){
Â  // build last 12 months sums
Â  const now = new Date();
Â  const months = [];
Â  const revData = [], expData = [];
Â  for(let i=11;i>=0;i--){
Â  Â  const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
Â  Â  const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
Â  Â  months.push(d.toLocaleString('default',{month:'short',year:'numeric'}));
Â  Â  const entries = state.entries.filter(en=> en.date.startsWith(key));
Â  Â  const rev = entries.filter(e=>e.type==='income').reduce((s,e)=>s+Number(e.amount),0);
Â  Â  const exp = entries.filter(e=>e.type==='expense').reduce((s,e)=>s+Number(e.amount),0);
Â  Â  revData.push(rev); expData.push(exp);
Â  }

Â  const ctx = document.getElementById('chartMonthly').getContext('2d');
Â  if(monthlyChart) monthlyChart.destroy();
Â  monthlyChart = new Chart(ctx, {
Â  Â  type:'line',
Â  Â  data:{
Â  Â  Â  labels: months,
Â  Â  Â  datasets:[
Â  Â  Â  Â  {label:'Revenue', data:revData, tension:0.3, borderColor:'#06b6d4', backgroundColor:'rgba(6,182,212,0.06)', fill:true},
Â  Â  Â  Â  {label:'Expenses', data:expData, tension:0.3, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.06)', fill:true}
Â  Â  Â  ]
Â  Â  },
Â  Â  options:{responsive:true,plugins:{legend:{position:'top'}}}
Â  });
}

/* ---- Dashboard numbers ---- */
function updateDashboard(){
Â  const rev = state.entries.filter(e=>e.type==='income').reduce((s,e)=>s+Number(e.amount),0);
Â  const exp = state.entries.filter(e=>e.type==='expense').reduce((s,e)=>s+Number(e.amount),0);
Â  document.getElementById('statRevenue').innerText = formatMoney(rev);
Â  document.getElementById('statExpenses').innerText = formatMoney(exp);
Â  document.getElementById('statNet').innerText = formatMoney(rev-exp);
Â  updateMonthlyChart();
}

/* ---- Cars table ---- */
function renderCarsTable(){
Â  const tbody = document.querySelector('#carsTable tbody'); tbody.innerHTML='';
Â  state.cars.forEach(c=>{
Â  Â  const count = state.entries.filter(e=>e.carId===c.id).length;
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `<td>${escapeHtml(c.name)}</td>
Â  Â  Â  <td>${escapeHtml(c.plate || '')}</td>
Â  Â  Â  <td style="font-weight:700">${formatMoney(c.dailyRent || 0)}</td>
Â  Â  Â  <td class="muted">${count} entries</td>
Â  Â  Â  <td style="text-align:left">
Â  Â  Â  Â  <button class="btn ghost" data-act="edit" data-id="${c.id}">Edit</button>
Â  Â  Â  Â  <button class="btn" data-act="del" data-id="${c.id}" style="background:#fee2e2;color:var(--danger)">Delete</button>
Â  Â  Â  </td>`;
Â  Â  tbody.appendChild(tr);
Â  });
}

/* ---- Entries list & form ---- */
function populateCarSelects(){
Â  const selects = ['entryCar','filterCar','reportCar','entryCar'];
Â  selects.forEach(id=>{
Â  Â  const el = document.getElementById(id);
Â  Â  if(!el) return;
Â  Â  el.innerHTML = '<option value="all">All cars</option>';
Â  Â  state.cars.forEach(c=> el.insertAdjacentHTML('beforeend', `<option value="${c.id}">${escapeHtml(c.name)}</option>`));
Â  });
}
function renderEntriesTable(filter=null){
Â  populateCarSelects();
Â  const tbody = document.querySelector('#entriesTable tbody'); tbody.innerHTML='';
Â  let rows = state.entries.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
Â  // apply filter if any
Â  const carFilter = document.getElementById('filterCar').value;
Â  const from = document.getElementById('filterFrom').value;
Â  const to = document.getElementById('filterTo').value;
Â  if(carFilter && carFilter!=='all') rows = rows.filter(r=> r.carId===carFilter);
Â  if(from) rows = rows.filter(r=> r.date >= from);
Â  if(to) rows = rows.filter(r=> r.date <= to);

Â  rows.forEach((e,i)=>{
Â  Â  const car = state.cars.find(c=>c.id===e.carId);
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `<td>${e.date}</td>
Â  Â  Â  <td>${escapeHtml(car?car.name:'-')}</td>
Â  Â  Â  <td>${e.type==='income'?'<span class="tag in">Income</span>':'<span class="tag out">Expense</span>'}</td>
Â  Â  Â  <td>${escapeHtml(e.category||'')}</td>
Â  Â  Â  <td style="font-weight:800">${formatMoney(e.amount)}</td>
Â  Â  Â  <td>${escapeHtml(e.note||'')}</td>
Â  Â  Â  <td style="text-align:left">
Â  Â  Â  Â  <button class="btn ghost" data-act="edit-entry" data-id="${e.id}">Edit</button>
Â  Â  Â  Â  <button class="btn" data-act="del-entry" data-id="${e.id}" style="background:#fee2e2;color:var(--danger)">Delete</button>
Â  Â  Â  </td>`;
Â  Â  tbody.appendChild(tr);
Â  });
}

/* ---- Reports ---- */
function renderReportSummary(){
Â  const carId = document.getElementById('reportCar').value;
Â  const from = document.getElementById('reportFrom').value;
Â  const to = document.getElementById('reportTo').value;
Â  let rows = state.entries.slice();
Â  if(carId && carId!=='all') rows = rows.filter(r=>r.carId===carId);
Â  if(from) rows = rows.filter(r=>r.date>=from);
Â  if(to) rows = rows.filter(r=>r.date<=to);
Â  const income = rows.filter(r=>r.type==='income').reduce((s,r)=>s+Number(r.amount),0);
Â  const expense = rows.filter(r=>r.type==='expense').reduce((s,r)=>s+Number(r.amount),0);
Â  const net = income - expense;
Â  const out = document.getElementById('reportSummary');
Â  out.innerHTML = `<div style="display:flex;gap:16px"><div class="card" style="flex:1"><div class="muted">Revenue</div><div style="font-weight:800;font-size:20px">${formatMoney(income)}</div></div>
Â  Â  <div class="card" style="flex:1"><div class="muted">Expenses</div><div style="font-weight:800;font-size:20px">${formatMoney(expense)}</div></div>
Â  Â  <div class="card" style="flex:1"><div class="muted">Net</div><div style="font-weight:800;font-size:20px">${formatMoney(net)}</div></div></div>
Â  Â  <div style="margin-top:12px">
Â  Â  Â  <table style="width:100%"><thead><tr><th>Date</th><th>Car</th><th>Type</th><th>Category</th><th>Amount</th></tr></thead>
Â  Â  Â  <tbody>${rows.map(r=>`<tr><td>${r.date}</td><td>${escapeHtml((state.cars.find(c=>c.id===r.carId)||{}).name||'-')}</td><td>${r.type}</td><td>${r.category}</td><td style="font-weight:700">${formatMoney(r.amount)}</td></tr>`).join('')}</tbody></table>
Â  Â  </div>`;
}

/* ---- Users ---- */
function renderUsers(){
Â  const tbody = document.querySelector('#usersTable tbody'); tbody.innerHTML='';
Â  state.users.forEach(u=>{
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `<td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.email)}</td><td>${escapeHtml(u.role)}</td>
Â  Â  Â  <td style="text-align:left">
Â  Â  Â  Â  <button class="btn ghost" data-act="impersonate" data-id="${u.id}">Impersonate</button>
Â  Â  Â  Â  <button class="btn" data-act="del-user" data-id="${u.id}" style="background:#fee2e2;color:var(--danger)">Delete</button>
Â  Â  Â  </td>`;
Â  Â  tbody.appendChild(tr);
Â  });
}

/* ============================
Â  Â Events & actions
Â  Â ============================ */

// Add car
document.getElementById('btnAddCar').addEventListener('click', ()=>{
Â  const name = document.getElementById('carName').value.trim();
Â  const plate = document.getElementById('carPlate').value.trim();
Â  const dailyRent = parseFloat(document.getElementById('carDailyRent').value) || 0; // Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
Â  if(!name) return alert('Enter car name');
Â  const id = 'c'+Date.now().toString(36);
Â  state.cars.push({id,name,plate,dailyRent});
Â  saveState(); 
Â  document.getElementById('carName').value=''; 
Â  document.getElementById('carPlate').value='';
Â  document.getElementById('carDailyRent').value='';
Â  renderCarsTable(); populateCarSelects(); updateDashboard();
});

// Cars actions (edit/delete)
document.querySelector('#carsTable tbody').addEventListener('click', (ev)=>{
Â  const btn = ev.target.closest('button'); if(!btn) return;
Â  const act = btn.dataset.act; const id = btn.dataset.id;
Â  if(act==='del'){
Â  Â  if(!confirm('Delete car and its entries?')) return;
Â  Â  state.cars = state.cars.filter(c=>c.id!==id);
Â  Â  state.entries = state.entries.filter(e=>e.carId!==id);
Â  Â  saveState(); renderCarsTable(); renderEntriesTable(); updateDashboard();
Â  } else if(act==='edit'){
Â  Â  const car = state.cars.find(c=>c.id===id);
Â  Â  const newName = prompt('Car name', car.name);
Â  Â  const newRent = prompt('Daily Rent', car.dailyRent);
Â  Â  if(newName){ car.name=newName; }
Â  Â  if(newRent!==null){ car.dailyRent=parseFloat(newRent) || 0; }
Â  Â  if(newName || newRent!==null){ saveState(); renderCarsTable(); populateCarSelects(); renderEntriesTable(); updateDashboard(); }
Â  }
});

// Add entry
document.getElementById('btnAddEntry').addEventListener('click', ()=>{
Â  const carId = document.getElementById('entryCar').value;
Â  const date = document.getElementById('entryDate').value || new Date().toISOString().slice(0,10);
Â  const type = document.getElementById('entryType').value;
Â  const amount = parseFloat(document.getElementById('entryAmount').value);
Â  const category = document.getElementById('entryCategory').value.trim();
Â  if(!carId || carId==='all') return alert('Select a car'); if(isNaN(amount) || amount<=0) return alert('Enter a valid amount');
Â  const id = 'e'+Date.now().toString(36);
Â  state.entries.push({id,carId,date,type,amount,category,note:''});
Â  saveState(); document.getElementById('entryAmount').value=''; document.getElementById('entryCategory').value='';
Â  renderEntriesTable(); updateDashboard();
});

// Entries table actions
document.querySelector('#entriesTable tbody').addEventListener('click', (ev)=>{
Â  const btn = ev.target.closest('button'); if(!btn) return;
Â  const act = btn.dataset.act; const id = btn.dataset.id;
Â  if(act==='del-entry'){ if(!confirm('Delete this entry?')) return; state.entries = state.entries.filter(e=>e.id!==id); saveState(); renderEntriesTable(); updateDashboard(); }
Â  if(act==='edit-entry'){ const e = state.entries.find(x=>x.id===id); const newAmt = prompt('Amount', e.amount); if(newAmt!==null){ e.amount = parseFloat(newAmt); saveState(); renderEntriesTable(); updateDashboard(); } }
});

// Filters
document.getElementById('btnApplyFilter').addEventListener('click', ()=> renderEntriesTable());
document.getElementById('btnClearFilter').addEventListener('click', ()=> { document.getElementById('filterCar').value='all'; document.getElementById('filterFrom').value=''; document.getElementById('filterTo').value=''; renderEntriesTable(); });

// Report generation
document.getElementById('btnGenerate').addEventListener('click', ()=> renderReportSummary());

// Export report CSV
document.getElementById('btnExportCSVReport').addEventListener('click', ()=>{
Â  const html = document.getElementById('reportSummary').innerText;
Â  // build CSV from current filtered rows
Â  const carId = document.getElementById('reportCar').value;
Â  const from = document.getElementById('reportFrom').value;
Â  const to = document.getElementById('reportTo').value;
Â  let rows = state.entries.slice();
Â  if(carId && carId!=='all') rows = rows.filter(r=>r.carId===carId);
Â  if(from) rows = rows.filter(r=>r.date>=from); if(to) rows = rows.filter(r=>r.date<=to);
Â  let csv = 'date,car,type,category,amount\n';
Â  rows.forEach(r=> csv += `${r.date},${(state.cars.find(c=>c.id===r.carId)||{}).name || ''},${r.type},${r.category || ''},${r.amount}\n`);
Â  downloadFile('report.csv', 'text/csv;charset=utf-8;', csv);
});

// Export report Excel (SheetJS)
document.getElementById('btnExportXLS').addEventListener('click', ()=>{
Â  const carId = document.getElementById('reportCar').value;
Â  const from = document.getElementById('reportFrom').value;
Â  const to = document.getElementById('reportTo').value;
Â  let rows = state.entries.slice();
Â  if(carId && carId!=='all') rows = rows.filter(r=>r.carId===carId);
Â  if(from) rows = rows.filter(r=>r.date>=from); if(to) rows = rows.filter(r=>r.date<=to);
Â  const wsData = [['Date','Car','Type','Category','Amount']];
Â  rows.forEach(r=> wsData.push([r.date,(state.cars.find(c=>c.id===r.carId)||{}).name||'',r.type,r.category||'',r.amount]));
Â  const wb = XLSX.utils.book_new();
Â  const ws = XLSX.utils.aoa_to_sheet(wsData);
Â  XLSX.utils.book_append_sheet(wb, ws, 'Report');
Â  XLSX.writeFile(wb, 'report.xlsx');
});

// Export report PDF (jsPDF)
document.getElementById('btnExportPDF').addEventListener('click', async ()=>{
Â  const { jsPDF } = window.jspdf;
Â  const doc = new jsPDF({unit:'pt',format:'a4'});
Â  const title = 'Car Rental Report';
Â  doc.setFontSize(14); doc.text(title,40,40);
Â  // add summary text
Â  doc.setFontSize(11);
Â  const summaryText = document.getElementById('reportSummary').innerText;
Â  doc.text(summaryText,40,70);
Â  doc.save('report.pdf');
});

// Backup download
document.getElementById('btnDownload').addEventListener('click', ()=> {
Â  const blob = JSON.stringify(state, null, 2);
Â  downloadFile('backup_car_rental.json','application/json;charset=utf-8;', blob);
});

// Upload/restore backup
document.getElementById('btnUpload').addEventListener('click', ()=> {
Â  const inp = document.createElement('input'); inp.type='file'; inp.accept='.json';
Â  inp.onchange = async ()=> {
Â  Â  const file = inp.files[0]; if(!file) return;
Â  Â  const txt = await file.text();
Â  Â  try{
Â  Â  Â  const obj = JSON.parse(txt);
Â  Â  Â  // basic validation
Â  Â  Â  if(!obj.cars || !obj.entries || !obj.users){ return alert('Invalid backup file'); }
Â  Â  Â  if(!confirm('Restore backup? This will replace current data.')) return;
Â  Â  Â  state = obj; saveState(); renderAll(); alert('Restored');
Â  Â  }catch(err){ alert('Invalid file'); }
Â  };
Â  inp.click();
});

// Clear all data (reset)
document.getElementById('btnClearAll').addEventListener('click', ()=> {
Â  if(!confirm('Reset everything to default?')) return;
Â  state = defaultState(); saveState(); renderAll(); alert('Reset done');
});

// Auto backup controls
document.getElementById('autoBackupToggle').addEventListener('change', (e)=>{
Â  const enabled = e.target.checked;
Â  localStorage.setItem(AUTO_BACKUP_KEY, JSON.stringify({enabled,ts:Date.now()}));
Â  setupAutoBackup();
});
document.getElementById('btnDownloadBackup').addEventListener('click', ()=> {
Â  const copy = JSON.stringify(state, null, 2);
Â  downloadFile('autobackup.json','application/json;charset=utf-8;', copy);
});
function setupAutoBackup(){
Â  const raw = JSON.parse(localStorage.getItem(AUTO_BACKUP_KEY) || 'null');
Â  const enabled = raw && raw.enabled;
Â  document.getElementById('autoBackupToggle').checked = !!enabled;
Â  if(autoBackupTimer) { clearInterval(autoBackupTimer); autoBackupTimer = null; }
Â  if(enabled){
Â  Â  const minutes = parseInt(document.getElementById('settingAutoInterval').value || '60',10);
Â  Â  autoBackupTimer = setInterval(()=> {
Â  Â  Â  localStorage.setItem('car_rental_pro_backup', JSON.stringify({ts:Date.now(),state}));
Â  Â  Â  console.log('Auto backup saved');
Â  Â  }, Math.max(1,minutes) * 60 * 1000);
Â  }
}

// Settings apply
document.getElementById('settingAutoInterval').addEventListener('change', ()=> { setupAutoBackup(); saveState(); });
document.getElementById('settingCurrency').addEventListener('change', ()=> { state.settings.currency = document.getElementById('settingCurrency').value; saveState(); updateDashboard(); });
document.getElementById('settingTheme').addEventListener('change', (e)=> {
Â  state.settings.theme = e.target.value; saveState();
Â  // simple theme switch
Â  if(e.target.value==='dark') document.body.style.background = '#0b1220'; else document.body.style.background = 'var(--bg)';
});

// Users management
document.getElementById('btnAddUser').addEventListener('click', ()=>{
Â  const name = document.getElementById('newUserName').value.trim();
Â  const email = document.getElementById('newUserEmail').value.trim();
Â  const role = document.getElementById('newUserRole').value;
Â  if(!name||!email) return alert('Fill name and email');
Â  const id = Date.now();
Â  state.users.push({id,name,email,password:'123456',role});
Â  saveState(); renderUsers(); alert('User added (default password: 123456)');
});

// Users actions
document.querySelector('#usersTable tbody').addEventListener('click', (ev)=>{
Â  const btn = ev.target.closest('button'); if(!btn) return;
Â  const act = btn.dataset.act; const id = parseInt(btn.dataset.id, 10);

Â  if(act==='del-user'){
Â  Â  // ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø´Ø· Ø­Ø§Ù„ÙŠÙ‹Ø§
Â  Â  if(currentUser && currentUser.id === id) return alert('Cannot delete current user.');
Â  Â  if(!confirm('Delete this user?')) return;
Â  Â  state.users = state.users.filter(u=>u.id!==id);
Â  Â  saveState(); renderUsers();
Â  } else if(act==='impersonate'){
Â  Â  const user = state.users.find(u=>u.id===id);
Â  Â  if(user){
Â  Â  Â  currentUser = user;
Â  Â  Â  localStorage.setItem('cr_current_user', JSON.stringify(currentUser));
Â  Â  Â  showTab('dashboard'); // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
Â  Â  Â  alert(`Switched to user: ${user.name} (${user.role})`);
Â  Â  }
Â  }
});

// Login button actions
document.getElementById('btnLogin').addEventListener('click', ()=> {
Â  document.getElementById('modalLogin').style.display = 'flex';
});
document.getElementById('btnCloseLogin').addEventListener('click', ()=> {
Â  document.getElementById('modalLogin').style.display = 'none';
});
document.getElementById('btnDoLogin').addEventListener('click', ()=> {
Â  const email = document.getElementById('loginEmail').value.trim();
Â  const pass = document.getElementById('loginPass').value.trim();
Â  const user = state.users.find(u=> u.email===email && u.password===pass);
Â  if(user){
Â  Â  currentUser = user;
Â  Â  localStorage.setItem('cr_current_user', JSON.stringify(currentUser));
Â  Â  document.getElementById('modalLogin').style.display = 'none';
Â  Â  showTab('dashboard');
Â  Â  alert(`Signed in as ${user.name} (${user.role})`);
Â  }else{
Â  Â  alert('Invalid credentials');
Â  }
});

// Initial setup to run on load
function renderAll(){
Â  populateCarSelects();
Â  showTab(document.querySelector('#nav button.active').dataset.tab);
Â  document.getElementById('settingCurrency').value = state.settings.currency;
Â  document.getElementById('settingAutoInterval').value = state.settings.autoBackupIntervalMinutes;
Â  document.getElementById('settingTheme').value = state.settings.theme;
Â  // Apply initial theme setting
Â  if(state.settings.theme==='dark') document.body.style.background = '#0b1220';
Â  else document.body.style.background = 'var(--bg)';
}

document.addEventListener('DOMContentLoaded', ()=> {
Â  // Process daily rent before rendering dashboard
Â  processDailyRent();
Â  renderAll();
Â  setupAutoBackup();
Â  // Set default date for entry
Â  document.getElementById('entryDate').value = new Date().toISOString().slice(0,10);
});
</script>
</body>
</html>