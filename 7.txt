<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Car Rental PRO ‚Äî Dashboard (Firebase)</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  /* Minimal professional styling, English dashboard */
  :root{
    --bg:#f4f6fb;
    --sidebar:#0f1724;
    --accent:#06b6d4;
    --muted:#6b7280;
    --card:#ffffff;
    --danger:#ef4444;
    --success:#10b981;
    --text:#0b1220;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  body{margin:0;background:var(--bg);color:var(--text);min-height:100vh}
  .app{display:flex;height:100vh;overflow:hidden}
  .sidebar{
    width:300px;background:linear-gradient(180deg,var(--sidebar),#0b1220);
    color:#fff;padding:24px;display:flex;flex-direction:column;gap:12px;
  }
  .logo{font-weight:800;font-size:18px;display:flex;align-items:center;gap:10px}
  .badge{background:var(--accent);color:#012;padding:6px 10px;border-radius:8px;font-weight:700}
  .small{color:#9aa4b2;font-size:13px}
  .nav{margin-top:10px;display:flex;flex-direction:column;gap:6px}
  .nav button{background:transparent;border:none;color:#dbeafe;padding:12px 14px;text-align:right;border-radius:10px;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center; direction: rtl;}
  .nav button.active{background:rgba(255,255,255,0.06)}
  .main{flex:1;padding:22px;overflow:auto}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:linear-gradient(90deg,var(--accent),#6d28d9);border:none;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
  .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:16px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .stat-title{font-size:13px;color:var(--muted)}
  .stat-value{font-size:22px;font-weight:800;margin-top:6px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:right;font-size:14px}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid #e6eef6;background:#fff;width:100%;font-size:14px}
  .row{display:flex;gap:10px}
  .row .col{flex:1}
  .tag{padding:6px 8px;border-radius:999px;font-weight:700; text-align: center;}
  .tag.in{background:var(--success);color:#021}
  .tag.out{background:var(--danger);color:#021}
  .muted{color:var(--muted)}
  @media(max-width:980px){.grid3{grid-template-columns:1fr}.sidebar{display:none}}
  /* align LTR elements */
  .ltr{direction:ltr;text-align:left}
</style>
</head>
<body>
<div class="app" id="appRoot">

  <aside class="sidebar" id="sidebar">
    <div class="logo"><div class="badge">CR</div><div style="line-height:1">Car Rental <span style="color:#94a3b8;font-weight:600">PRO</span></div></div>
    <div class="small">Welcome, <strong id="uiUser">Guest</strong></div>

    <nav class="nav" id="nav">
      <button data-tab="dashboard" class="active">Dashboard <span class="muted">üìä</span></button>
      <button data-tab="cars">Cars <span class="muted">üöò</span></button>
      <button data-tab="entries">Entries <span class="muted">üíµ</span></button>
      <button data-tab="reports">Reports <span class="muted">üìÑ</span></button>
      <button data-tab="backup">Backup <span class="muted">üóÇ</span></button>
      <button data-tab="settings">Settings <span class="muted">‚öôÔ∏è</span></button>
      <button data-tab="users">Users <span class="muted">üë•</span></button>
    </nav>

    <div style="margin-top:10px">
      <button id="btnLogin" class="btn ghost" style="width:100%">Login / Switch</button>
    </div>

    <div class="foot muted" style="margin-top:auto">
      Local-like demo backed by Firestore ‚Äî data stored in your Firebase project.
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <h1 style="margin:0">Car Rental PRO ‚Äî Admin Dashboard</h1>
      <div class="controls">
        <label class="muted" style="font-size:13px">Auto-backup</label>
        <input type="checkbox" id="autoBackupToggle" />
        <button id="btnDownloadBackup" class="btn ghost">Download Backup</button>
        <button id="btnImportBackup" class="btn">Import Backup</button>
      </div>
    </div>

    <!-- Dashboard -->
    <section id="tab-dashboard" class="tab">
      <h2 style="margin:0 0 12px 0;">Dashboard</h2>
      <div class="grid3" style="margin-bottom:12px">
        <div class="card stat-box">
          <div class="stat-title">Total Revenue</div>
          <div class="stat-value ltr" id="statRevenue">0</div>
          <div class="small muted">Monthly trend <span style="color:var(--success)">+12%</span></div>
        </div>
        <div class="card stat-box">
          <div class="stat-title">Total Expenses</div>
          <div class="stat-value ltr" id="statExpenses">0</div>
          <div class="small muted">Monthly trend <span style="color:var(--danger)">-5%</span></div>
        </div>
        <div class="card stat-box">
          <div class="stat-title">Net Profit</div>
          <div class="stat-value ltr" id="statNet">0</div>
          <div class="small muted">Monthly trend <span style="color:var(--success)">+7%</span></div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Monthly Chart</h3>
          <div class="muted">Revenue vs Expenses</div>
        </div>
        <canvas id="chartMonthly" height="120" style="margin-top:12px"></canvas>
      </div>
    </section>

    <!-- Cars -->
    <section id="tab-cars" class="tab" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Manage Cars</h3>
          <div class="muted">Add / Edit / Remove cars</div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="col"><input id="carName" placeholder="Car name / model (e.g. Toyota Corolla 2019)" /></div>
          <div style="width:160px"><input id="carPlate" placeholder="Plate (optional)" /></div>
          <div style="width:160px"><input id="carDailyRent" placeholder="Daily rent" type="number" min="0" step="0.01" /></div>
          <div style="width:120px"><button id="btnAddCar" class="btn">Add Car</button></div>
        </div>

        <div style="margin-top:14px">
          <table id="carsTable">
            <thead><tr><th>Car</th><th>Plate</th><th>Daily Rent</th><th>Entries</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Entries -->
    <section id="tab-entries" class="tab" style="display:none">
      <div class="card">
        <h3 style="margin:0">Add Entry (Income / Expense)</h3>
        <div class="muted">Record income or expense for any car</div>

        <div style="margin-top:12px" class="row">
          <div class="col"><select id="entryCar"><option value="all">Choose car</option></select></div>
          <div style="width:170px"><input id="entryDate" type="date" /></div>
          <div style="width:140px">
            <select id="entryType"><option value="income">Income</option><option value="expense">Expense</option></select>
          </div>
        </div>

        <div style="margin-top:10px" class="row">
          <div class="col"><input id="entryAmount" placeholder="Amount (number)" type="number" step="0.01" /></div>
          <div class="col"><input id="entryCategory" placeholder="Category (e.g. rent, fuel, maintenance)" /></div>
          <div style="width:160px"><button id="btnAddEntry" class="btn">Save Entry</button></div>
        </div>

      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Entries List</h3>
          <div>
            <select id="filterCar" style="width:140px"><option value="all">All cars</option></select>
            <input id="filterFrom" type="date" style="width:140px" />
            <input id="filterTo" type="date" style="width:140px" />
            <button id="btnApplyFilter" class="btn ghost">Apply</button>
            <button id="btnClearFilter" class="btn ghost">Clear</button>
          </div>
        </div>

        <div style="margin-top:12px;overflow:auto">
          <table id="entriesTable">
            <thead><tr><th>Date</th><th>Car</th><th>Type</th><th>Category</th><th>Amount</th><th>Note</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Reports -->
    <section id="tab-reports" class="tab" style="display:none">
      <div class="card">
        <h3 style="margin:0">Generate Reports</h3>
        <div class="muted">Create summary or customized reports and export</div>

        <div style="margin-top:12px" class="row">
          <div class="col"><select id="reportCar"><option value="all">All cars</option></select></div>
          <div style="width:170px"><input id="reportFrom" type="date" /></div>
          <div style="width:170px"><input id="reportTo" type="date" /></div>
          <div style="width:130px"><button id="btnGenerate" class="btn">Generate</button></div>
        </div>

        <div style="margin-top:12px" id="reportSummary" class="card">
          <p class="muted">Click "Generate" to show results here.</p>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="btnExportCSVReport" class="btn ghost">Export CSV</button>
          <button id="btnExportXLS" class="btn ghost">Export Excel</button>
          <button id="btnExportPDF" class="btn">Export PDF</button>
        </div>
      </div>
    </section>

    <!-- Backup -->
    <section id="tab-backup" class="tab" style="display:none">
      <div class="card">
        <h3>Backup / Restore</h3>
        <div class="muted">Download JSON backup or restore from file.</div>
        <div style="margin-top:12px" class="row">
          <div style="width:160px"><button id="btnDownload" class="btn">Download Backup</button></div>
          <div style="width:160px"><button id="btnUpload" class="btn ghost">Restore Backup</button></div>
          <div style="width:200px"><button id="btnClearAll" class="btn ghost" style="background:#fee2e2;color:var(--danger)">Reset All Data</button></div>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section id="tab-settings" class="tab" style="display:none">
      <div class="card">
        <h3>Settings</h3>
        <div class="muted">Currency, auto-backup interval, theme</div>

        <div style="margin-top:12px">
          <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0">
            <div>
              <div style="font-weight:700">Currency</div>
              <div class="muted">Display currency (suffix)</div>
            </div>
            <div style="width:200px"><input id="settingCurrency" value="MRU" /></div>
          </div>

          <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0">
            <div>
              <div style="font-weight:700">Auto backup interval (minutes)</div>
              <div class="muted">When enabled, this controls autosave frequency</div>
            </div>
            <div style="width:220px"><input id="settingAutoInterval" type="number" min="1" value="60" /></div>
          </div>

          <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0">
            <div>
              <div style="font-weight:700">Theme</div>
              <div class="muted">Light / Dark</div>
            </div>
            <div style="width:160px">
              <select id="settingTheme"><option value="light">Light</option><option value="dark">Dark</option></select>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Users -->
    <section id="tab-users" class="tab" style="display:none">
      <div class="card">
        <h3>Users & Roles</h3>
        <div class="muted">Manage app users (demo auth) ‚Äî admin can create/delete users</div>

        <div style="margin-top:12px" class="row">
          <div class="col"><input id="newUserName" placeholder="Full name" /></div>
          <div class="col"><input id="newUserEmail" placeholder="Email" /></div>
          <div style="width:160px"><select id="newUserRole"><option value="admin">admin</option><option value="manager">manager</option><option value="user">user</option></select></div>
          <div style="width:120px"><button id="btnAddUser" class="btn">Add user</button></div>
        </div>

        <div style="margin-top:12px">
          <table id="usersTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Login modal -->
<div id="modalLogin" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);align-items:center;justify-content:center;z-index:50">
  <div style="background:#fff;padding:18px;border-radius:12px;width:420px; text-align: right;">
    <h3 style="margin:0 0 8px 0">Login (demo)</h3>
    <div class="small">Demo users: admin@demo (admin), manager@demo (manager), user@demo (user) ‚Äî password: 123456</div>
    <div style="margin-top:12px" class="row">
      <div class="col"><input id="loginEmail" placeholder="Email" value="admin@demo" /></div>
      <div style="width:160px"><input id="loginPass" placeholder="Password" value="123456" /></div>
      </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="btnDoLogin" class="btn">Login</button>
      <button id="btnCloseLogin" class="btn ghost">Close</button>
    </div>
  </div>
</div>

<!-- Firebase modular SDK (ES module) + app code -->
<script type="module">
  // ---------- Firebase setup ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs,
    onSnapshot, updateDoc, deleteDoc, query, where, orderBy
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // <-- Use the firebaseConfig you provided -->
  const firebaseConfig = {
    apiKey: "AIzaSyAHzWZ2RyIkkY5IvOefLONXe0Gjk5BFozM",
    authDomain: "cars-9b2bd.firebaseapp.com",
    projectId: "cars-9b2bd",
    storageBucket: "cars-9b2bd.firebasestorage.app",
    messagingSenderId: "934983307820",
    appId: "1:934983307820:web:03496c1f3818e25ab2f789"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- Local caches ----------
  let carsCache = [];
  let entriesCache = [];
  let usersCache = [];
  let settingsCache = { currency: 'MRU', autoBackupIntervalMinutes: 60, theme: 'light' };

  // ---------- Helpers ----------
  function l(key){ return document.getElementById(key); }
  function fmtMoney(amount){
    const cur = settingsCache.currency || 'MRU';
    const n = Number(amount) || 0;
    // Use Intl to format number, append currency abbreviation
    return n.toLocaleString('en-US', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' ' + cur;
  }

  // ---------- Real-time listeners ----------
  // Cars
  const carsCol = collection(db, 'cars');
  onSnapshot(carsCol, snap => {
    carsCache = [];
    snap.forEach(d => carsCache.push({ id: d.id, ...d.data() }));
    renderCarsTable();
    populateCarSelects();
    updateDashboard();
  }, err => console.error('cars snapshot error', err));

  // Entries
  const entriesCol = collection(db, 'entries');
  onSnapshot(entriesCol, snap => {
    entriesCache = [];
    snap.forEach(d => entriesCache.push({ id: d.id, ...d.data() }));
    renderEntriesTable();
    updateDashboard();
  }, err => console.error('entries snapshot error', err));

  // Users
  const usersCol = collection(db, 'users');
  onSnapshot(usersCol, snap => {
    usersCache = [];
    snap.forEach(d => usersCache.push({ id: d.id, ...d.data() }));
    renderUsers();
  }, err => console.error('users snapshot error', err));

  // Settings doc (single doc)
  const settingsDocRef = doc(db, 'meta', 'settings');
  async function loadSettings(){
    try{
      const sdoc = await getDoc(settingsDocRef);
      if(sdoc.exists()){
        settingsCache = {...settingsCache, ...sdoc.data()};
      } else {
        await setDoc(settingsDocRef, settingsCache);
      }
      // apply to UI
      l('settingCurrency').value = settingsCache.currency || 'MRU';
      l('settingAutoInterval').value = settingsCache.autoBackupIntervalMinutes || 60;
      l('settingTheme').value = settingsCache.theme || 'light';
      applyTheme(settingsCache.theme || 'light');
    }catch(err){ console.error('load settings error', err); }
  }
  loadSettings();

  // ---------- Daily rent meta doc ----------
  const dailyMetaRef = doc(db, 'meta', 'daily_rent');

  async function getLastRentDate(){
    try{
      const d = await getDoc(dailyMetaRef);
      if(d.exists()) return d.data().lastDate || null;
      return null;
    }catch(err){ console.error(err); return null; }
  }
  async function setLastRentDate(dateStr){
    try{ await setDoc(dailyMetaRef, { lastDate: dateStr }); } catch(err){ console.error(err); }
  }

  // ---------- UI rendering ----------
  function renderCarsTable(){
    const tbody = l('carsTable').querySelector('tbody'); tbody.innerHTML = '';
    carsCache.forEach(c => {
      const count = entriesCache.filter(e=>e.carId===c.id).length;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(c.name)}</td>
        <td>${escapeHtml(c.plate || '')}</td>
        <td class="ltr" style="font-weight:700">${fmtMoney(c.dailyRent || 0)}</td>
        <td class="muted">${count} entries</td>
        <td style="text-align:left">
          <button class="btn ghost" data-act="edit" data-id="${c.id}">Edit</button>
          <button class="btn" data-act="del" data-id="${c.id}" style="background:#fee2e2;color:var(--danger)">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function populateCarSelects(){
    const selects = ['entryCar','filterCar','reportCar'];
    selects.forEach(id=>{
      const el = l(id); if(!el) return;
      const currentVal = el.value || 'all';
      el.innerHTML = '<option value="all">All cars</option>';
      carsCache.forEach(c => el.insertAdjacentHTML('beforeend', `<option value="${c.id}">${escapeHtml(c.name)}</option>`));
      el.value = currentVal;
    });
  }

  function renderEntriesTable(){
    populateCarSelects();
    const tbody = l('entriesTable').querySelector('tbody'); tbody.innerHTML = '';
    let rows = entriesCache.slice().sort((a,b)=> new Date(b.date) - new Date(a.date));
    // filters
    const carFilter = l('filterCar').value;
    const from = l('filterFrom').value;
    const to = l('filterTo').value;
    if(carFilter && carFilter!=='all') rows = rows.filter(r=> r.carId===carFilter);
    if(from) rows = rows.filter(r=> r.date >= from);
    if(to) rows = rows.filter(r=> r.date <= to);

    rows.forEach(e=>{
      const car = carsCache.find(c=>c.id===e.carId);
      const typeTag = e.type==='income' ? '<span class="tag in">Income</span>' : '<span class="tag out">Expense</span>';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="ltr">${e.date}</td>
        <td>${escapeHtml(car?car.name:'-')}</td>
        <td>${typeTag}</td>
        <td>${escapeHtml(e.category||'')}</td>
        <td class="ltr" style="font-weight:800">${fmtMoney(e.amount)}</td>
        <td>${escapeHtml(e.note||'')}</td>
        <td style="text-align:left">
          <button class="btn ghost" data-act="edit-entry" data-id="${e.id}">Edit</button>
          <button class="btn" data-act="del-entry" data-id="${e.id}" style="background:#fee2e2;color:var(--danger)">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function renderReportSummary(){
    const carId = l('reportCar').value;
    const from = l('reportFrom').value;
    const to = l('reportTo').value;
    let rows = entriesCache.slice();
    if(carId && carId!=='all') rows = rows.filter(r=>r.carId===carId);
    if(from) rows = rows.filter(r=>r.date>=from);
    if(to) rows = rows.filter(r=>r.date<=to);
    const income = rows.filter(r=>r.type==='income').reduce((s,r)=>s+Number(r.amount),0);
    const expense = rows.filter(r=>r.type==='expense').reduce((s,r)=>s+Number(r.amount),0);
    const net = income - expense;
    const out = l('reportSummary');
    out.innerHTML = `<div style="display:flex;gap:16px; flex-wrap: wrap;">
      <div class="card" style="flex:1; min-width: 150px;"><div class="muted">Revenue</div><div style="font-weight:800;font-size:20px">${fmtMoney(income)}</div></div>
      <div class="card" style="flex:1; min-width: 150px;"><div class="muted">Expenses</div><div style="font-weight:800;font-size:20px">${fmtMoney(expense)}</div></div>
      <div class="card" style="flex:1; min-width: 150px;"><div class="muted">Net</div><div style="font-weight:800;font-size:20px">${fmtMoney(net)}</div></div>
      </div>
      <div style="margin-top:12px">
        <table style="width:100%"><thead><tr><th>Date</th><th>Car</th><th>Type</th><th>Category</th><th>Amount</th></tr></thead>
        <tbody>${rows.map(r=>`<tr><td class="ltr">${r.date}</td><td>${escapeHtml((carsCache.find(c=>c.id===r.carId)||{}).name||'-')}</td><td>${r.type === 'income' ? 'Income' : 'Expense'}</td><td>${escapeHtml(r.category)}</td><td class="ltr" style="font-weight:700">${fmtMoney(r.amount)}</td></tr>`).join('')}</tbody></table>
      </div>`;
  }

  function renderUsers(){
    const tbody = l('usersTable').querySelector('tbody'); tbody.innerHTML = '';
    usersCache.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.email)}</td><td>${escapeHtml(u.role)}</td>
        <td style="text-align:left">
          <button class="btn ghost" data-act="impersonate" data-id="${u.id}">Impersonate</button>
          <button class="btn" data-act="del-user" data-id="${u.id}" style="background:#fee2e2;color:var(--danger)">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function updateDashboard(){
    const rev = entriesCache.filter(e=>e.type==='income').reduce((s,e)=>s+Number(e.amount),0);
    const exp = entriesCache.filter(e=>e.type==='expense').reduce((s,e)=>s+Number(e.amount),0);
    l('statRevenue').innerText = fmtMoney(rev);
    l('statExpenses').innerText = fmtMoney(exp);
    l('statNet').innerText = fmtMoney(rev-exp);
    updateMonthlyChart();
  }

  // Chart
  let monthlyChart = null;
  function updateMonthlyChart(){
    const now = new Date();
    const months = [];
    const revData = [], expData = [];
    for(let i=11;i>=0;i--){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
      months.push(d.toLocaleString('default',{month:'short',year:'numeric'}));
      const entries = entriesCache.filter(en=> en.date.startsWith(key));
      const rev = entries.filter(e=>e.type==='income').reduce((s,e)=>s+Number(e.amount),0);
      const exp = entries.filter(e=>e.type==='expense').reduce((s,e)=>s+Number(e.amount),0);
      revData.push(rev); expData.push(exp);
    }
    const ctx = document.getElementById('chartMonthly').getContext('2d');
    if(monthlyChart) monthlyChart.destroy();
    monthlyChart = new Chart(ctx, {
      type:'line',
      data:{
        labels: months,
        datasets:[
          {label:'Revenue', data:revData, tension:0.3, borderColor:'#06b6d4', backgroundColor:'rgba(6,182,212,0.06)', fill:true},
          {label:'Expenses', data:expData, tension:0.3, borderColor:'#ef4444', backgroundColor:'rgba(239,68,68,0.06)', fill:true}
        ]
      },
      options:{responsive:true,plugins:{legend:{position:'top'}}}
    });
  }

  // ---------- CRUD operations (cars / entries / users) ----------
  async function addCarToDB(obj){
    try{
      await addDoc(carsCol, obj);
    }catch(err){ console.error('addCar error', err); alert('Add car failed'); }
  }
  async function deleteCarFromDB(id){
    try{
      await deleteDoc(doc(db,'cars',id));
    }catch(err){ console.error(err); alert('Delete car failed'); }
  }
  async function updateCarInDB(id, payload){
    try{ await updateDoc(doc(db,'cars',id), payload); }catch(err){ console.error(err); }
  }

  async function addEntryToDB(obj){
    try{ await addDoc(entriesCol, obj); }catch(err){ console.error('addEntry error', err); alert('Add entry failed'); }
  }
  async function deleteEntryFromDB(id){
    try{ await deleteDoc(doc(db,'entries',id)); }catch(err){ console.error(err); alert('Delete entry failed'); }
  }
  async function updateEntryInDB(id,payload){
    try{ await updateDoc(doc(db,'entries',id), payload); }catch(err){ console.error(err); }
  }

  async function addUserToDB(obj){
    try{ await addDoc(usersCol, obj); }catch(err){ console.error(err); alert('Add user failed'); }
  }
  async function deleteUserFromDB(id){
    try{ await deleteDoc(doc(db,'users',id)); }catch(err){ console.error(err); alert('Delete user failed'); }
  }

  // ---------- Daily Rent Automation ----------
  // runs once on load and whenever date changes (checks each minute)
  async function processDailyRent(){
    try{
      const today = new Date().toISOString().slice(0,10);
      const last = await getLastRentDate();
      if(last === today) { console.log('daily rent already processed'); return; }
      // add entries for each car with positive dailyRent
      for(const car of carsCache){
        const rent = Number(car.dailyRent) || 0;
        if(rent > 0){
          // avoid duplicates: ensure no entry with same carId,date,category
          const duplicate = entriesCache.some(e=> e.carId===car.id && e.date===today && e.category==='Daily Automated Rent');
          if(!duplicate){
            await addEntryToDB({
              carId: car.id,
              date: today,
              type: 'income',
              amount: rent,
              category: 'Daily Automated Rent',
              note: `Daily automated rent - ${car.name}`
            });
          }
        }
      }
      await setLastRentDate(today);
      console.log('daily rent processed for', today);
    }catch(err){ console.error('processDailyRent error', err); }
  }

  // check every minute if date changed (sufficient for client-side scheduling)
  let lastCheckedDate = new Date().toISOString().slice(0,10);
  setInterval(async ()=>{
    const nowDate = new Date().toISOString().slice(0,10);
    if(nowDate !== lastCheckedDate){
      lastCheckedDate = nowDate;
      await processDailyRent();
    }
  }, 60*1000); // every minute

  // also run once on load (after slight delay to let initial snapshots populate)
  setTimeout(()=>processDailyRent(), 1500);

  // ---------- UI events ----------
  // tabs
  document.querySelectorAll('#nav button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('#nav button').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      showTab(btn.dataset.tab);
    });
  });
  function showTab(id){
    document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
    const el = document.getElementById('tab-'+id);
    if(el) el.style.display='block';
    // update ui label
    l('uiUser').innerText = (window.currentUser && window.currentUser.name) ? `${window.currentUser.name} (${window.currentUser.role})` : 'Guest';
  }

  // Add car
  l('btnAddCar').addEventListener('click', async ()=>{
    const name = l('carName').value.trim();
    const plate = l('carPlate').value.trim();
    const dailyRent = parseFloat(l('carDailyRent').value) || 0;
    if(!name) return alert('Please enter car name');
    await addCarToDB({ name, plate, dailyRent });
    l('carName').value=''; l('carPlate').value=''; l('carDailyRent').value='';
  });

  // car table actions
  l('carsTable').querySelector('tbody').addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const act = btn.dataset.act; const id = btn.dataset.id;
    if(act === 'del'){ if(!confirm('Delete car and its entries?')) return; await deleteCarFromDB(id); // entries remain unless you want cascade
    } else if(act === 'edit'){ const car = carsCache.find(c=>c.id===id); const newName = prompt('Car name', car.name); const newRent = prompt('Daily rent', car.dailyRent); let updated=false; if(newName!==null && newName!==car.name){ await updateCarInDB(id,{name:newName}); updated=true;} if(newRent!==null && parseFloat(newRent)!==car.dailyRent){ await updateCarInDB(id,{dailyRent: parseFloat(newRent)||0}); updated=true;} if(updated) alert('Updated'); }
  });

  // add entry
  l('btnAddEntry').addEventListener('click', async ()=>{
    const carId = l('entryCar').value;
    const date = l('entryDate').value || new Date().toISOString().slice(0,10);
    const type = l('entryType').value;
    const amount = parseFloat(l('entryAmount').value);
    const category = l('entryCategory').value.trim();
    if(!carId || carId === 'all') return alert('Please choose a car');
    if(isNaN(amount) || amount <= 0) return alert('Please enter a valid amount');
    await addEntryToDB({ carId, date, type, amount, category: category || 'N/A', note: '' });
    l('entryAmount').value=''; l('entryCategory').value='';
  });

  // entries table actions
  l('entriesTable').querySelector('tbody').addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const act = btn.dataset.act; const id = btn.dataset.id;
    if(act==='del-entry'){ if(!confirm('Delete this entry?')) return; await deleteEntryFromDB(id);
    } else if(act==='edit-entry'){ const e = entriesCache.find(x=>x.id===id); const newAmt = prompt('Amount', e.amount); const newCat = prompt('Category', e.category); if(newAmt !== null){ await updateEntryInDB(id,{ amount: parseFloat(newAmt) || e.amount, category: newCat || e.category }); } }
  });

  // filters
  l('btnApplyFilter').addEventListener('click', ()=> renderEntriesTable());
  l('btnClearFilter').addEventListener('click', ()=> { l('filterCar').value='all'; l('filterFrom').value=''; l('filterTo').value=''; renderEntriesTable(); });

  // reports
  l('btnGenerate').addEventListener('click', ()=> renderReportSummary());

  // export CSV
  l('btnExportCSVReport').addEventListener('click', ()=>{
    const carId = l('reportCar').value;
    const from = l('reportFrom').value;
    const to = l('reportTo').value;
    let rows = entriesCache.slice();
    if(carId && carId!=='all') rows = rows.filter(r=>r.carId===carId);
    if(from) rows = rows.filter(r=>r.date>=from); if(to) rows = rows.filter(r=>r.date<=to);
    let csv = 'date,car,type,category,amount\n';
    rows.forEach(r=> csv += `${r.date},${(carsCache.find(c=>c.id===r.carId)||{}).name || ''},${r.type},${(r.category||'')},${r.amount}\n`);
    downloadFile('report.csv','text/csv;charset=utf-8;',csv);
  });

  // export excel (basic using CSV fallback) -- full XLSX requires extra lib
  l('btnExportXLS').addEventListener('click', ()=> l('btnExportCSVReport').click());

  // export pdf - simple text
  l('btnExportPDF').addEventListener('click', ()=>{
    // use a simple window.print style as fallback (or you can integrate jsPDF)
    alert('PDF export uses jsPDF in advanced mode ‚Äî not included to keep this bundle minimal. Use CSV export as fallback.');
  });

  // Backup / restore
  l('btnDownload').addEventListener('click', async ()=>{
    const backup = { cars: carsCache, entries: entriesCache, users: usersCache, settings: settingsCache, ts: Date.now() };
    downloadFile('car_rental_backup.json','application/json;charset=utf-8;', JSON.stringify(backup,null,2));
  });

  l('btnUpload').addEventListener('click', ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.json';
    inp.onchange = async ()=> {
      const file = inp.files[0]; if(!file) return;
      const txt = await file.text();
      try{
        const obj = JSON.parse(txt);
        if(!obj.cars || !obj.entries) return alert('Invalid backup file');
        if(!confirm('Restore backup? This will INSERT backup data into Firestore (will not auto-delete existing docs). Continue?')) return;
        // insert docs (careful: this adds duplicates if run many times)
        for(const c of obj.cars) { await addDoc(carsCol, { name:c.name, plate:c.plate || '', dailyRent:c.dailyRent || 0 }); }
        for(const e of obj.entries) { await addDoc(entriesCol, { carId:e.carId, date:e.date, type:e.type, amount:e.amount, category:e.category || '', note:e.note || '' }); }
        alert('Backup data imported (appended).');
      }catch(err){ alert('Invalid file'); }
    };
    inp.click();
  });

  l('btnClearAll').addEventListener('click', async ()=>{
    if(!confirm('Reset app to default demo state? This will NOT automatically delete Firestore documents. Proceed?')) return;
    // Simpler approach: instruct user to delete collections in Firebase console.
    alert('To fully reset, please delete collections from Firebase console -> Firestore (cars, entries, users, meta).');
  });

  // Settings changes
  l('settingAutoInterval').addEventListener('change', async ()=>{
    settingsCache.autoBackupIntervalMinutes = parseInt(l('settingAutoInterval').value || '60',10);
    await setDoc(settingsDocRef, settingsCache, { merge: true });
    setupAutoBackup();
  });
  l('settingCurrency').addEventListener('change', async ()=>{
    settingsCache.currency = l('settingCurrency').value.trim() || 'MRU';
    await setDoc(settingsDocRef, settingsCache, { merge: true });
    updateDashboard();
  });
  l('settingTheme').addEventListener('change', (e)=> {
    settingsCache.theme = e.target.value;
    setDoc(settingsDocRef, settingsCache, { merge: true }).catch(()=>{});
    applyTheme(settingsCache.theme);
  });

  function applyTheme(theme){
    const root = document.documentElement.style;
    if(theme === 'dark'){
      document.body.style.background = '#071024'; document.body.style.color = '#fff';
      root.setProperty('--card','#0b1220'); root.setProperty('--muted','#94a3b8');
    } else {
      document.body.style.background = 'var(--bg)'; document.body.style.color = 'var(--text)';
      root.setProperty('--card','#ffffff'); root.setProperty('--muted','#6b7280');
    }
  }

  // Users
  l('btnAddUser').addEventListener('click', async ()=>{
    const name = l('newUserName').value.trim(), email = l('newUserEmail').value.trim(), role = l('newUserRole').value;
    if(!name||!email) return alert('Please fill name and email');
    // naive duplicate check by email: check local cache
    if(usersCache.some(u=>u.email===email)) return alert('Email already in use');
    await addUserToDB({ name, email, password:'123456', role });
    l('newUserName').value=''; l('newUserEmail').value='';
    alert('User added with default password 123456');
  });

  l('usersTable').querySelector('tbody').addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const act = btn.dataset.act; const id = btn.dataset.id;
    if(act==='del-user'){ if(!confirm('Delete this user?')) return; await deleteUserFromDB(id); }
    if(act==='impersonate'){ const u = usersCache.find(x=>x.id===id); if(u){ window.currentUser = u; localStorage.setItem('cr_current_user', JSON.stringify(u)); showTab('dashboard'); alert(`Impersonated: ${u.name}`); } }
  });

  // Login modal
  l('btnLogin').addEventListener('click', ()=> l('modalLogin').style.display = 'flex');
  l('btnCloseLogin').addEventListener('click', ()=> l('modalLogin').style.display = 'none');
  l('btnDoLogin').addEventListener('click', ()=>{
    const email = l('loginEmail').value.trim(), pass = l('loginPass').value.trim();
    const user = usersCache.find(u=>u.email===email && u.password===pass);
    if(user){ window.currentUser = user; localStorage.setItem('cr_current_user', JSON.stringify(user)); l('modalLogin').style.display = 'none'; showTab('dashboard'); alert(`Logged in as ${user.name}`); }
    else alert('Invalid credentials');
  });

  // ---------- Utility ----------
  function escapeHtml(str){ if(typeof str !== 'string') return str; return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
  function downloadFile(filename, contentType, content){
    const a = document.createElement('a'); const blob = new Blob([content], { type: contentType }); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  // ---------- Initialization ----------
  // set default demo users in Firestore if no users exist
  async function ensureDemoUsers(){
    try{
      // read users once
      const snap = await getDocs(usersCol);
      if(snap.empty){
        await addDoc(usersCol, { name:'Administrator', email:'admin@demo', password:'123456', role:'admin' });
        await addDoc(usersCol, { name:'Manager', email:'manager@demo', password:'123456', role:'manager' });
        await addDoc(usersCol, { name:'Staff', email:'user@demo', password:'123456', role:'user' });
      }
    }catch(err){ console.error('ensureDemoUsers', err); }
  }
  ensureDemoUsers();

  // Setup auto backup (client-side)
  let autoBackupTimer = null;
  function setupAutoBackup(){
    if(autoBackupTimer) { clearInterval(autoBackupTimer); autoBackupTimer=null; }
    const raw = settingsCache.autoBackupIntervalMinutes || 60;
    const minutes = Math.max(1, parseInt(raw || '60',10));
    if(l('autoBackupToggle').checked){
      autoBackupTimer = setInterval(()=>{
        // store a snapshot under meta/backups
        setDoc(doc(db,'meta','last_autobackup'), { ts: Date.now(), stateSnapshot: { cars: carsCache, entries: entriesCache, users: usersCache } }).catch(()=>{});
        console.log('Auto backup saved');
      }, minutes * 60 * 1000);
    }
  }
  l('autoBackupToggle').addEventListener('change', setupAutoBackup);
  setupAutoBackup();

  // initial UI state
  function initialUI(){
    const cu = JSON.parse(localStorage.getItem('cr_current_user') || 'null');
    if(cu){ window.currentUser = cu; }
    l('entryDate').value = new Date().toISOString().slice(0,10);
    // show dashboard by default
    showTab('dashboard');
  }
  initialUI();

  // call loadSettings already above; ensure autosave setup after settings load
  // small delay to let onSnapshot populate caches
  setTimeout(()=>{ processDailyRent(); setupAutoBackup(); }, 2000);

</script>
</body>
</html>
